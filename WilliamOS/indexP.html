<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Sistema de Inventario (Bootstrap)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    th { cursor:pointer; user-select:none; }
    mark { background: #ffeb3b; padding:0; }
    .col-active { background:#eef6ff !important; }
    .table-responsive { max-height: 60vh; overflow:auto; }
    /* small tweaks */
    .flecha { margin-left:6px; font-weight:700; }
    .btn-icon { display:inline-flex; align-items:center; gap:6px; }
  </style>
</head>
<body class="container py-4">

  <h1 class="mb-3">üì¶ Sistema de Inventario</h1>

  <!-- TOP ACTIONS -->
  <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <input type="file" id="inputExcel" accept=".xlsx,.xls" style="display:none" onchange="importarExcel(event)">
    <button class="btn btn-outline-secondary btn-icon" onclick="document.getElementById('inputExcel').click()">üìÇ Importar Excel</button>

    <input type="file" id="inputJSON" accept=".json" style="display:none" onchange="importarJSON(event)">
    <button class="btn btn-outline-secondary btn-icon" onclick="document.getElementById('inputJSON').click()">üìÇ Importar JSON</button>

    <button class="btn btn-success btn-icon" onclick="exportarJSON()">üíæ Exportar JSON</button>
    <button class="btn btn-success btn-icon" onclick="exportarExcel()">üìä Exportar Excel</button>
    <button class="btn btn-success btn-icon" onclick="exportarPDF()">üìë Exportar PDF</button>

    <button class="btn btn-danger btn-icon ms-auto" onclick="limpiarInventario()">üóëÔ∏è Limpiar Inventario</button>
  </div>

  <!-- LISTAS PREDEFINIDAS -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">‚öôÔ∏è Listas predefinidas (ed√≠talas y se aplicar√°n a los selects)</h5>
      <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Categor√≠as (comas)</label>
          <input id="listaCategorias" class="form-control" value="Medicinas,Equipos,Insumos" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Tipos (comas)</label>
          <input id="listaTipos" class="form-control" value="Activo,Consumible" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Sedes (comas)</label>
          <input id="listaSedes" class="form-control" value="Central,Norte,Sur" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Pisos (comas)</label>
          <input id="listaPisos" class="form-control" value="1,2,3" />
        </div>
      </div>
      <div class="mt-2">
        <button class="btn btn-primary btn-sm" onclick="actualizarListas()">Aplicar listas</button>
        <small class="text-muted ms-2">Las listas se usan para poblar los selects del formulario.</small>
      </div>
    </div>
  </div>

  <!-- FORM -->
  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">‚ûï Agregar / Editar item</h5>
      <form id="formInventario" class="row g-2">
        <input type="hidden" id="index" />
        <div class="col-md-4"><input id="descripcion" class="form-control" placeholder="Descripci√≥n" required /></div>
        <div class="col-md-2"><input id="cantidad" type="number" min="0" step="1" class="form-control" placeholder="Cantidad" required/></div>
        <div class="col-md-2"><input id="precio" type="number" min="0" step="0.01" class="form-control" placeholder="Precio" required/></div>
        <div class="col-md-2"><input id="codigo" class="form-control" placeholder="C√≥digo"/></div>
        <div class="col-md-2"><input id="fIngreso" type="date" class="form-control"/></div>

        <div class="col-md-3"><select id="categoria" class="form-select"></select></div>
        <div class="col-md-3"><select id="tipo" class="form-select"></select></div>
        <div class="col-md-3"><select id="sede" class="form-select"></select></div>
        <div class="col-md-3"><select id="piso" class="form-select"></select></div>

        <div class="col-md-2"><input id="grupo" class="form-control" placeholder="Grupo"/></div>
        <div class="col-md-2"><input id="marca" class="form-control" placeholder="Marca"/></div>
        <div class="col-md-2"><input id="modelo" class="form-control" placeholder="Modelo"/></div>
        <div class="col-md-2"><input id="serie" class="form-control" placeholder="Serie"/></div>
        <div class="col-md-2"><input id="ubicacion" class="form-control" placeholder="Ubicaci√≥n"/></div>
        <div class="col-md-4"><input id="observacion" class="form-control" placeholder="Observaci√≥n"/></div>

        <div class="col-md-2">
          <button class="btn btn-primary w-100" type="submit">üíæ Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- FILTER & ACTIONS -->
  <div class="d-flex gap-2 align-items-center mb-2">
    <input id="buscar" class="form-control me-2" placeholder="Buscar (se resalta en la tabla)" oninput="onFiltroChange()" />
    <div class="ms-auto d-flex gap-2 align-items-center">
      <label class="mb-0">Mostrar</label>
      <select id="registrosPagina" class="form-select form-select-sm w-auto" onchange="cambiarRegistrosPorPagina()">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <label class="mb-0">registros</label>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card mb-2">
    <div class="card-body">
      <h5 class="card-title">üìã Inventario</h5>
      <div class="table-responsive">
        <table id="tablaInventario" class="table table-striped table-hover table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th onclick="ordenarPor('descripcion')">Descripci√≥n <span id="icon-descripcion" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('cantidad')">Cantidad <span id="icon-cantidad" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('precio')">Precio <span id="icon-precio" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('codigo')">C√≥digo <span id="icon-codigo" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('fIngreso')">F-Ingreso <span id="icon-fIngreso" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('categoria')">Categor√≠a <span id="icon-categoria" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('tipo')">Tipo <span id="icon-tipo" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('grupo')">Grupo <span id="icon-grupo" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('marca')">Marca <span id="icon-marca" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('modelo')">Modelo <span id="icon-modelo" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('serie')">Serie <span id="icon-serie" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('ubicacion')">Ubicaci√≥n <span id="icon-ubicacion" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('piso')">Piso <span id="icon-piso" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('sede')">Sede <span id="icon-sede" class="flecha">‚¨ç</span></th>
              <th onclick="ordenarPor('observacion')">Observaci√≥n <span id="icon-observacion" class="flecha">‚¨ç</span></th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- totalizador -->
      <div id="totalizador" class="mt-2 fw-semibold"></div>

      <!-- paginaci√≥n -->
      <div id="paginacion" class="mt-2 d-flex align-items-center gap-2 flex-wrap"></div>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">üìú Historial de movimientos</h5>
      <button class="btn btn-danger btn-sm mb-2" onclick="limpiarHistorial()">üßπ Limpiar historial</button>
      <div class="table-responsive">
        <table id="tablaHistorial" class="table table-sm table-striped table-bordered">
          <thead class="table-secondary"><tr><th>Fecha</th><th>Acci√≥n</th><th>Detalle</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<!-- SCRIPTS -->
<script>
/* ----------------------- Estado y util ----------------------- */
const LS_INV = "inv_v1";
const LS_HIS = "his_v1";

let inventario = JSON.parse(localStorage.getItem(LS_INV)) || [];
let historial = JSON.parse(localStorage.getItem(LS_HIS)) || [];

let ordenActual = { columna: null, asc: true };
let paginaActual = 1;
let registrosPorPagina = Number(document.getElementById("registrosPagina").value || 10);

/* ----------------------- Helpers ----------------------- */
function saveInv(){ localStorage.setItem(LS_INV, JSON.stringify(inventario)); }
function saveHis(){ localStorage.setItem(LS_HIS, JSON.stringify(historial)); }
function now(){ return new Date().toLocaleString(); }
function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

/* Highlight safe: escape then replace on escaped string */
function highlightSafe(text, query){
  if(!query) return escapeHtml(text);
  const q = String(query).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); // escape regex
  const rx = new RegExp('('+q+')','gi');
  return escapeHtml(text).replace(rx, '<mark>$1</mark>');
}

/* Find index in original inventario (handles duplicates by identity) */
function findIndexOfItem(item){
  return inventario.indexOf(item);
}

/* ----------------------- Listas predefinidas ----------------------- */
function actualizarListas(){
  const cats = (document.getElementById("listaCategorias").value || "").split(",").map(s=>s.trim()).filter(Boolean);
  const tipos = (document.getElementById("listaTipos").value || "").split(",").map(s=>s.trim()).filter(Boolean);
  const sedes = (document.getElementById("listaSedes").value || "").split(",").map(s=>s.trim()).filter(Boolean);
  const pisos = (document.getElementById("listaPisos").value || "").split(",").map(s=>s.trim()).filter(Boolean);

  llenarSelect('categoria', cats);
  llenarSelect('tipo', tipos);
  llenarSelect('sede', sedes);
  llenarSelect('piso', pisos);

  // Re-render (to keep possible new items)
  mostrarInventario();
}

function llenarSelect(id, valores){
  const sel = document.getElementById(id);
  if(!sel) return;
  sel.innerHTML = '<option value="">--</option>' + valores.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
}

/* ----------------------- CRUD ----------------------- */
document.getElementById("formInventario").addEventListener("submit", function(e){
  e.preventDefault();
  const nuevo = {
    descripcion: document.getElementById("descripcion").value.trim(),
    cantidad: Number(document.getElementById("cantidad").value) || 0,
    precio: Number(document.getElementById("precio").value) || 0,
    codigo: document.getElementById("codigo").value.trim(),
    fIngreso: document.getElementById("fIngreso").value || "",
    categoria: document.getElementById("categoria").value || "",
    tipo: document.getElementById("tipo").value || "",
    grupo: document.getElementById("grupo").value.trim(),
    marca: document.getElementById("marca").value.trim(),
    modelo: document.getElementById("modelo").value.trim(),
    serie: document.getElementById("serie").value.trim(),
    ubicacion: document.getElementById("ubicacion").value.trim(),
    piso: document.getElementById("piso").value || "",
    sede: document.getElementById("sede").value || "",
    observacion: document.getElementById("observacion").value.trim()
  };

  const idx = document.getElementById("index").value;
  if(idx === ""){
    inventario.push(nuevo);
    registrar("Crear", `Se cre√≥: ${nuevo.descripcion} (${nuevo.codigo || 'sin c√≥digo'})`);
  } else {
    inventario[idx] = nuevo;
    registrar("Editar", `Se edit√≥: ${nuevo.descripcion} (${nuevo.codigo || 'sin c√≥digo'})`);
    document.getElementById("index").value = "";
  }
  saveInv();
  this.reset();
  // Reset to first page to show newly added row
  paginaActual = 1;
  mostrarInventario();
});

/* ----------------------- Mostrar tabla con paginaci√≥n y resaltar ----------------------- */
function getFilteredArray(){
  const q = (document.getElementById("buscar").value || "").toLowerCase();
  if(!q) return [...inventario];
  return inventario.filter(item => {
    return Object.values(item).some(v => String(v).toLowerCase().includes(q));
  });
}

function mostrarInventario(){
  const filtro = (document.getElementById("buscar").value || "").toLowerCase();
  const tbody = document.querySelector("#tablaInventario tbody");
  tbody.innerHTML = "";

  const filtrados = getFilteredArray();

  // ordenar si hay orden
  if(ordenActual.columna){
    filtrados.sort((a,b)=>{
      let A = a[ordenActual.columna] ?? "";
      let B = b[ordenActual.columna] ?? "";
      // handle numbers and dates
      if(ordenActual.columna === "fIngreso"){ A = new Date(A||0); B = new Date(B||0); }
      else if(typeof A === "number" && typeof B === "number"){}
      else if(!isNaN(Number(A)) && !isNaN(Number(B))){
        A = Number(A); B = Number(B);
      } else {
        A = String(A).toLowerCase(); B = String(B).toLowerCase();
      }
      if(A < B) return ordenActual.asc ? -1 : 1;
      if(A > B) return ordenActual.asc ? 1 : -1;
      return 0;
    });
  }

  // pagination
  const totalRegistros = filtrados.length;
  const totalPaginas = Math.max(1, Math.ceil(totalRegistros / registrosPorPagina));
  if(paginaActual > totalPaginas) paginaActual = totalPaginas;
  if(paginaActual < 1) paginaActual = 1;
  const inicio = (paginaActual - 1) * registrosPorPagina;
  const fin = inicio + registrosPorPagina;
  const paginaDatos = filtrados.slice(inicio, fin);

  // Render rows
  paginaDatos.forEach(item => {
    const idx = findIndexOfItem(item);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${highlightSafe(item.descripcion, filtro)}</td>
      <td>${highlightSafe(String(item.cantidad), filtro)}</td>
      <td>${highlightSafe(String(item.precio), filtro)}</td>
      <td>${highlightSafe(item.codigo, filtro)}</td>
      <td>${highlightSafe(item.fIngreso, filtro)}</td>
      <td>${highlightSafe(item.categoria, filtro)}</td>
      <td>${highlightSafe(item.tipo, filtro)}</td>
      <td>${highlightSafe(item.grupo, filtro)}</td>
      <td>${highlightSafe(item.marca, filtro)}</td>
      <td>${highlightSafe(item.modelo, filtro)}</td>
      <td>${highlightSafe(item.serie, filtro)}</td>
      <td>${highlightSafe(item.ubicacion, filtro)}</td>
      <td>${highlightSafe(item.piso, filtro)}</td>
      <td>${highlightSafe(item.sede, filtro)}</td>
      <td>${highlightSafe(item.observacion, filtro)}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editar(${idx})">‚úèÔ∏è Editar</button>
        <button class="btn btn-sm btn-danger" onclick="eliminar(${idx})">üóëÔ∏è Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // totalizador y paginaci√≥n UI
  mostrarTotalizador(filtrados);
  renderPaginacion(totalRegistros, totalPaginas);
  actualizarIconosOrden();
}

/* ----------------------- Totalizador ----------------------- */
function mostrarTotalizador(datosArray){
  const totalItems = datosArray.length;
  const totalCantidad = datosArray.reduce((acc, it) => acc + (Number(it.cantidad)||0), 0);
  const totalValor = datosArray.reduce((acc, it) => acc + ((Number(it.cantidad)||0) * (Number(it.precio)||0)), 0);
  // formato moneda (S/. Peru) ‚Äî si no soporta local, cae a number format simple
  let valorForm;
  try{
    valorForm = new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(totalValor);
  }catch{
    valorForm = totalValor.toFixed(2);
  }
  document.getElementById("totalizador").textContent = `üî¢ Registros: ${totalItems} ¬∑ üì¶ Cantidad: ${totalCantidad} ¬∑ üí∞ Valor total: ${valorForm}`;
}

/* ----------------------- Paginaci√≥n UI ----------------------- */
function renderPaginacion(totalRegistros, totalPaginas){
  const cont = document.getElementById("paginacion");
  cont.innerHTML = "";
  if(totalPaginas <= 1){
    cont.innerHTML = `<small class="text-muted">Mostrando todos los registros</small>`;
    return;
  }
  // First, Prev
  const btnFirst = document.createElement("button"); btnFirst.className="btn btn-sm btn-outline-secondary"; btnFirst.textContent="¬´ Primera";
  btnFirst.disabled = paginaActual === 1; btnFirst.onclick = ()=> { paginaActual = 1; mostrarInventario(); };
  cont.appendChild(btnFirst);

  const btnPrev = document.createElement("button"); btnPrev.className="btn btn-sm btn-outline-secondary ms-1"; btnPrev.textContent="‚Äπ Anterior";
  btnPrev.disabled = paginaActual === 1; btnPrev.onclick = ()=> { paginaActual = Math.max(1, paginaActual-1); mostrarInventario(); };
  cont.appendChild(btnPrev);

  // numeric pages: show range around current
  const span = document.createElement("span"); span.className="mx-2";
  const start = Math.max(1, paginaActual - 3);
  const end = Math.min(totalPaginas, paginaActual + 3);
  for(let i=start;i<=end;i++){
    const b = document.createElement("button"); b.className="btn btn-sm ms-1";
    b.classList.add(i===paginaActual ? "btn-primary" : "btn-outline-secondary");
    b.textContent = i; b.disabled = i===paginaActual;
    b.onclick = (ev)=> { paginaActual = i; mostrarInventario(); };
    span.appendChild(b);
  }
  cont.appendChild(span);

  const btnNext = document.createElement("button"); btnNext.className="btn btn-sm btn-outline-secondary ms-1"; btnNext.textContent="Siguiente ‚Ä∫";
  btnNext.disabled = paginaActual === totalPaginas; btnNext.onclick = ()=> { paginaActual = Math.min(totalPaginas, paginaActual+1); mostrarInventario(); };
  cont.appendChild(btnNext);

  const btnLast = document.createElement("button"); btnLast.className="btn btn-sm btn-outline-secondary ms-1"; btnLast.textContent="√öltima ¬ª";
  btnLast.disabled = paginaActual === totalPaginas; btnLast.onclick = ()=> { paginaActual = totalPaginas; mostrarInventario(); };
  cont.appendChild(btnLast);

  // goto page input
  const gotoDiv = document.createElement("div"); gotoDiv.className="ms-3 d-inline-flex align-items-center";
  gotoDiv.innerHTML = ` <small class="text-muted ms-2">Ir a:</small> `;
  const input = document.createElement("input"); input.type="number"; input.min=1; input.max=totalPaginas; input.value=paginaActual;
  input.style.width = "70px"; input.className="form-control form-control-sm ms-2";
  input.onkeydown = (e)=>{ if(e.key==='Enter'){ let v = Number(input.value); if(v>=1 && v<=totalPaginas){ paginaActual=v; mostrarInventario(); } } };
  gotoDiv.appendChild(input);
  cont.appendChild(gotoDiv);

  // summary
  const info = document.createElement("div"); info.className="ms-auto text-muted small";
  const from = (paginaActual-1)*registrosPorPagina + 1;
  const to = Math.min(totalRegistros, paginaActual*registrosPorPagina);
  info.innerHTML = `Mostrando ${from}‚Äì${to} de ${totalRegistros} registros (${totalPaginas} p√°ginas)`;
  cont.appendChild(info);
}

/* ----------------------- Edit / Delete ----------------------- */
function editar(i){
  const it = inventario[i];
  if(!it) return alert("Registro no encontrado");
  Object.keys(it).forEach(k=>{
    const el = document.getElementById(k);
    if(el) el.value = it[k];
  });
  document.getElementById("index").value = i;
  window.scrollTo({top:0, behavior:"smooth"});
}
function eliminar(i){
  if(!confirm("¬øEliminar este registro?")) return;
  registrar("Eliminar", `Se elimin√≥: ${inventario[i].descripcion} (${inventario[i].codigo||''})`);
  inventario.splice(i,1);
  saveInv();
  mostrarInventario();
}

/* ----------------------- Historial ----------------------- */
function registrar(accion, detalle){
  historial.unshift({ fecha: now(), accion, detalle });
  saveHis();
  renderHistorial();
}
function renderHistorial(){
  const tb = document.querySelector("#tablaHistorial tbody");
  tb.innerHTML = "";
  for(const h of historial){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(h.fecha)}</td><td>${escapeHtml(h.accion)}</td><td>${escapeHtml(h.detalle)}</td>`;
    tb.appendChild(tr);
  }
}
function limpiarHistorial(){ if(!confirm("¬øVaciar historial?")) return; historial=[]; saveHis(); renderHistorial(); }

/* ----------------------- Import / Export ----------------------- */
/* Import Excel: read first sheet and map columns if keys match expected */
function importarExcel(e){
  const file = e.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = function(evt){
    try{
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:"" });
      // If JSON contains our keys, adopt; otherwise try to map common headers
      const keys = ["descripcion","cantidad","precio","codigo","fIngreso","categoria","tipo","grupo","marca","modelo","serie","ubicacion","piso","sede","observacion"];
      const normalized = json.map(row=>{
        const nr = {};
        const rowKeys = Object.keys(row);
        for(const k of keys){
          // try exact match (case-insensitive)
          const found = rowKeys.find(rk => rk.toLowerCase() === k.toLowerCase());
          if(found) nr[k] = row[found];
          else {
            // try friendly matches (spanish words)
            const alt = rowKeys.find(rk => rk.toLowerCase().includes(k.toLowerCase()));
            nr[k] = alt ? row[alt] : (row[k] ?? "");
          }
        }
        // coerce numbers
        nr.cantidad = Number(nr.cantidad) || 0;
        nr.precio = Number(nr.precio) || 0;
        return nr;
      });
      inventario = normalized;
      saveInv(); paginaActual = 1; mostrarInventario();
      registrar("Importar", `Excel importado (${json.length} filas)`);
      alert("Excel importado ‚úÖ");
    }catch(err){
      alert("Error al importar Excel: " + err.message);
    } finally { e.target.value = ""; }
  };
  r.readAsArrayBuffer(file);
}

function importarJSON(e){
  const file = e.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = function(evt){
    try{
      const data = JSON.parse(evt.target.result);
      if(!Array.isArray(data)) throw new Error("JSON debe ser un arreglo de registros");
      inventario = data.map(it=>({
        descripcion: it.descripcion||"",
        cantidad: Number(it.cantidad)||0,
        precio: Number(it.precio)||0,
        codigo: it.codigo||"",
        fIngreso: it.fIngreso||"",
        categoria: it.categoria||"",
        tipo: it.tipo||"",
        grupo: it.grupo||"",
        marca: it.marca||"",
        modelo: it.modelo||"",
        serie: it.serie||"",
        ubicacion: it.ubicacion||"",
        piso: it.piso||"",
        sede: it.sede||"",
        observacion: it.observacion||""
      }));
      saveInv(); paginaActual=1; mostrarInventario();
      registrar("Importar", `JSON importado (${inventario.length} registros)`);
      alert("JSON importado ‚úÖ");
    }catch(err){ alert("Error al importar JSON: " + err.message); }
    finally{ e.target.value = ""; }
  };
  r.readAsText(file);
}

function exportarJSON(){
  const filtered = getFilteredArray();
  if(!filtered.length) return alert("No hay datos para exportar");
  const blob = new Blob([JSON.stringify(filtered, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = `Inventario_${new Date().toISOString().slice(0,10)}.json`; a.click();
  URL.revokeObjectURL(url);
  registrar("Exportar", "Exportado a JSON (filtrados)");
}

function exportarExcel(){
  const filtered = getFilteredArray();
  if(!filtered.length) return alert("No hay datos para exportar");
  const ws = XLSX.utils.json_to_sheet(filtered);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Inventario");
  XLSX.writeFile(wb, `Inventario_${new Date().toISOString().slice(0,10)}.xlsx`);
  registrar("Exportar", "Exportado a Excel (filtrados)");
}

function exportarPDF(){
  const { jsPDF } = window.jspdf;
  const filtered = getFilteredArray();
  if(!filtered.length) return alert("No hay datos para exportar");
  const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

  // Title
  doc.setFontSize(14);
  doc.text("üì¶ Reporte de Inventario", 40, 40);
  doc.setFontSize(9);
  doc.text(`Generado: ${now()}`, doc.internal.pageSize.getWidth() - 40, 40, { align: "right" });

  // Table
  const head = [["Descripci√≥n","Cantidad","Precio","C√≥digo","F-Ingreso","Categor√≠a","Tipo","Grupo","Marca","Modelo","Serie","Ubicaci√≥n","Piso","Sede","Observaci√≥n"]];
  const body = filtered.map(it => [
    it.descripcion, String(it.cantidad), String(it.precio), it.codigo, it.fIngreso, it.categoria, it.tipo,
    it.grupo, it.marca, it.modelo, it.serie, it.ubicacion, it.piso, it.sede, it.observacion
  ]);
  doc.autoTable({ head, body, startY: 70, styles:{fontSize:8, cellPadding:4}, headStyles:{fillColor:[44,123,229], textColor:255} });

  // footer page numbers
  const pages = doc.internal.getNumberOfPages();
  for(let i=1;i<=pages;i++){
    doc.setPage(i);
    doc.setFontSize(9);
    doc.text(`P√°gina ${i} de ${pages}`, doc.internal.pageSize.getWidth()/2, doc.internal.pageSize.getHeight()-20, { align: "center" });
  }

  doc.save(`Inventario_${new Date().toISOString().slice(0,10)}.pdf`);
  registrar("Exportar", "Exportado a PDF (filtrados)");
}

/* ----------------------- Orden y UI helpers ----------------------- */
function ordenarPor(col){
  if(ordenActual.columna === col) ordenActual.asc = !ordenActual.asc;
  else { ordenActual.columna = col; ordenActual.asc = true; }
  mostrarInventario();
}
function actualizarIconosOrden(){
  // reset icons
  document.querySelectorAll('th .flecha').forEach(s=>s.textContent = '‚¨ç');
  document.querySelectorAll('#tablaInventario tbody td').forEach(td=>td.classList.remove('col-active'));
  if(ordenActual.columna){
    const icon = document.getElementById('icon-' + ordenActual.columna);
    if(icon){
      icon.textContent = ordenActual.asc ? '‚Üë' : '‚Üì';
      const th = icon.closest('th');
      th.classList.add('col-active');
      const thIndex = Array.from(th.parentElement.children).indexOf(th);
      document.querySelectorAll('#tablaInventario tbody tr').forEach(tr=>{
        const td = tr.children[thIndex];
        if(td) td.classList.add('col-active');
      });
    }
  }
}

/* ----------------------- Misc controls ----------------------- */
function cambiarRegistrosPorPagina(){
  registrosPorPagina = Number(document.getElementById("registrosPagina").value) || 10;
  paginaActual = 1;
  mostrarInventario();
}
function onFiltroChange(){
  paginaActual = 1;
  mostrarInventario();
}

/* ----------------------- Clear / Init ----------------------- */
function limpiarInventario(){
  if(!confirm("¬øEliminar TODO el inventario?")) return;
  inventario = [];
  saveInv();
  paginaActual = 1;
  registrar("Limpiar", "Inventario borrado");
  mostrarInventario();
}

function init(){
  // fill selects with default list values
  actualizarListas();
  // render tables
  mostrarInventario();
  renderHistorial();
  // wire Enter key in search to reset page
  document.getElementById("buscar").addEventListener("keydown", (e)=>{ if(e.key==='Enter'){ e.preventDefault(); paginaActual=1; mostrarInventario(); } });
}

// init
init();

</script>
</body>
</html>
